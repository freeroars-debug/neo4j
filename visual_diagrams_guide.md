# Visual Guide: GlobalEntityRegistry Data Flow
# =============================================

## ğŸ“Š DIAGRAM 1: The Problem Without Registry

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    PROCESSING WITHOUT REGISTRY                            â•‘
â•‘                           (THE BROKEN WAY)                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Chunk 0:                          Chunk 1:                          Chunk 2:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "Apple was      â”‚              â”‚ "Steve Jobs     â”‚              â”‚ "Apple acquired â”‚
â”‚  founded by     â”‚              â”‚  introduced     â”‚              â”‚  Beats in 2014" â”‚
â”‚  Steve Jobs"    â”‚              â”‚  the iPhone"    â”‚              â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                â”‚                                â”‚
         â”‚ LLM Extract                    â”‚ LLM Extract                    â”‚ LLM Extract
         â–¼                                â–¼                                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ N1:Appleâ”‚                      â”‚N1:S.Jobsâ”‚                      â”‚ N1:Appleâ”‚
    â”‚N2:S.Jobsâ”‚                      â”‚N2:iPhoneâ”‚                      â”‚N2:Beats â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                                â”‚                                â”‚
         â”‚ Create UID                     â”‚ Create UID                     â”‚ Create UID
         â”‚ (local to chunk)               â”‚ (local to chunk)               â”‚ (local to chunk)
         â–¼                                â–¼                                â–¼
  uid_map={                          uid_map={                        uid_map={
    N1: hash(doc+apple)               N1: hash(doc+sjobs)              N1: hash(doc+apple)
    N2: hash(doc+sjobs)               N2: hash(doc+iphone)             N2: hash(doc+beats)
  }                                  }                                 }
         â”‚                                â”‚                                â”‚
         â”‚ Insert to Neo4j                â”‚ Insert to Neo4j                â”‚ Insert to Neo4j
         â–¼                                â–¼                                â–¼

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           NEO4J GRAPH                                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  FOUNDED_BY  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  INTRODUCED  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â•‘
â•‘  â”‚ Apple â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚Steve Jobs â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ iPhone â”‚          â•‘
â•‘  â”‚(0:N1) â”‚              â”‚  (0:N2)   â”‚              â”‚ (1:N2) â”‚          â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â•‘
â•‘                                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  ACQUIRED    â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                       â•‘
â•‘  â”‚ Apple â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Beats â”‚                                       â•‘
â•‘  â”‚(2:N1) â”‚              â”‚(2:N2) â”‚                                       â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”˜                                       â•‘
â•‘                                                                           â•‘
â•‘  âŒ PROBLEM: TWO Apple nodes! (0:N1) and (2:N1)                         â•‘
â•‘  âŒ PROBLEM: Can't connect Apple(0) to Beats because they're in         â•‘
â•‘              different chunks and different nodes!                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“Š DIAGRAM 2: The Solution With Registry

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      PROCESSING WITH REGISTRY                             â•‘
â•‘                          (THE CORRECT WAY)                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PHASE 1: COLLECT ALL CHUNKS AND BUILD REGISTRY
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Chunk 0:                    Chunk 1:                    Chunk 2:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ N1: Apple   â”‚            â”‚N1:Steve Jobsâ”‚            â”‚ N1: Apple   â”‚
â”‚ N2:S. Jobs  â”‚            â”‚ N2: iPhone  â”‚            â”‚ N2: Beats   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                          â”‚                          â”‚
       â”‚                          â”‚                          â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                        Register All Entities
                                  â–¼
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘              GLOBAL ENTITY REGISTRY                           â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘                                                               â•‘
    â•‘  entities = {                                                 â•‘
    â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â•‘
    â•‘    â”‚ "apple" â†’ {                                  â”‚          â•‘
    â•‘    â”‚   uid: "abc123"                              â”‚          â•‘
    â•‘    â”‚   name: "Apple"                              â”‚          â•‘
    â•‘    â”‚   chunks: [0, 2]  â† Appears in 2 chunks!    â”‚          â•‘
    â•‘    â”‚ }                                            â”‚          â•‘
    â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â•‘
    â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â•‘
    â•‘    â”‚ "steve jobs" â†’ {                             â”‚          â•‘
    â•‘    â”‚   uid: "def456"                              â”‚          â•‘
    â•‘    â”‚   chunks: [0, 1]                             â”‚          â•‘
    â•‘    â”‚ }                                            â”‚          â•‘
    â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â•‘
    â•‘    "iphone" â†’ { uid: "xyz789", chunks: [1] }                 â•‘
    â•‘    "beats" â†’ { uid: "jkl012", chunks: [2] }                  â•‘
    â•‘  }                                                            â•‘
    â•‘                                                               â•‘
    â•‘  local_to_global = {                                          â•‘
    â•‘    "0:N1" â†’ "abc123"  â”                                      â•‘
    â•‘    "2:N1" â†’ "abc123"  â”´â”€ Both map to SAME Apple!            â•‘
    â•‘    "0:N2" â†’ "def456"  â”                                      â•‘
    â•‘    "1:N1" â†’ "def456"  â”´â”€ Both map to SAME Steve Jobs!       â•‘
    â•‘    "1:N2" â†’ "xyz789"                                         â•‘
    â•‘    "2:N2" â†’ "jkl012"                                         â•‘
    â•‘  }                                                            â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


PHASE 2: CREATE NODES IN NEO4J
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

For each entity in registry.entities.values():
  â†“
  MERGE (n:Entity {uid: entity.uid})  â† MERGE prevents duplicates!
  â†“

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    NODES CREATED IN NEO4J                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                   â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â•‘
â•‘  â”‚ Apple               â”‚    â”‚ Steve Jobs          â”‚               â•‘
â•‘  â”‚ uid: abc123         â”‚    â”‚ uid: def456         â”‚               â•‘
â•‘  â”‚ chunks: [0, 2]      â”‚    â”‚ chunks: [0, 1]      â”‚               â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â•‘
â•‘                                                                   â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â•‘
â•‘  â”‚ iPhone              â”‚    â”‚ Beats               â”‚               â•‘
â•‘  â”‚ uid: xyz789         â”‚    â”‚ uid: jkl012         â”‚               â•‘
â•‘  â”‚ chunks: [1]         â”‚    â”‚ chunks: [2]         â”‚               â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â•‘
â•‘                                                                   â•‘
â•‘  âœ“ Only 4 nodes (not 6!)                                          â•‘
â•‘  âœ“ Apple appears once with chunks=[0,2]                           â•‘
â•‘  âœ“ Steve Jobs appears once with chunks=[0,1]                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


PHASE 3: CREATE RELATIONSHIPS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Relationship from Chunk 0: {from: "N1", to: "N2", type: "FOUNDED_BY"}
  â†“
  1. Resolve IDs using registry:
     source_uid = registry.resolve_uid(0, "N1")  â†’ "abc123" (Apple)
     target_uid = registry.resolve_uid(0, "N2")  â†’ "def456" (Steve Jobs)
  â†“
  2. Create in Neo4j:
     MATCH (a:Entity {uid: "abc123"})
     MATCH (b:Entity {uid: "def456"})
     MERGE (a)-[r:RELATIONSHIP]->(b)
  â†“

Relationship from Chunk 2: {from: "N1", to: "N2", type: "ACQUIRED"}
  â†“
  1. Resolve IDs:
     source_uid = registry.resolve_uid(2, "N1")  â†’ "abc123" (Apple)
                                                     â†‘
                                          SAME Apple as Chunk 0!
     target_uid = registry.resolve_uid(2, "N2")  â†’ "jkl012" (Beats)
  â†“
  2. Create relationship - works perfectly!
  â†“

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    FINAL GRAPH IN NEO4J                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                   â•‘
â•‘                  [FOUNDED_BY]         [INTRODUCED]               â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â” â•‘
â•‘   â”‚ Apple  â”‚                 â”‚Steve Jobs  â”‚             â”‚iPhoneâ”‚ â•‘
â•‘   â”‚ abc123 â”‚                 â”‚  def456    â”‚             â”‚xyz789â”‚ â•‘
â•‘   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”˜ â•‘
â•‘       â”‚                                                           â•‘
â•‘       â”‚ [ACQUIRED]                                                â•‘
â•‘       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                â•‘
â•‘                        â”‚ Beats  â”‚                                â•‘
â•‘                        â”‚ jkl012 â”‚                                â•‘
â•‘                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â•‘
â•‘                                                                   â•‘
â•‘  âœ“ ONE Apple node with TWO relationships (from chunks 0 and 2)  â•‘
â•‘  âœ“ All entities connected properly                               â•‘
â•‘  âœ“ Zero orphaned nodes                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“Š DIAGRAM 3: Registry Data Structures (Detailed)

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     GLOBAL ENTITY REGISTRY INTERNALS                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  registry.entities: Dict[str, dict]                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                â”‚
â”‚  Purpose: Store unique entities by normalized name                      â”‚
â”‚  Key: Normalized entity name (lowercase, trimmed)                       â”‚
â”‚  Value: Complete entity information                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

entities = {
    
  "apple": {                           â† Key: normalized name
      "uid": "abc123",                 â† Generated: hash("apple")
      "name": "Apple",                 â† Original name (for display)
      "normalized_name": "apple",      â† Normalized version
      "chunks": [0, 2],                â† Which chunks mention this entity
      "properties": {                  â† All extracted properties
          "name": "Apple",
          "type": "Organization"
      },
      "entity_type": "Organization"    â† Neo4j label
  },
  
  "steve jobs": {
      "uid": "def456",                 â† Generated: hash("steve jobs")
      "name": "Steve Jobs",
      "chunks": [0, 1],                â† Appears in chunks 0 AND 1
      "properties": {
          "name": "Steve Jobs",
          "type": "Person"
      },
      "entity_type": "Person"
  },
  
  "iphone": {
      "uid": "xyz789",
      "name": "iPhone",
      "chunks": [1],                   â† Only in chunk 1
      "entity_type": "Product"
  },
  
  "beats electronics": {
      "uid": "jkl012",
      "name": "Beats Electronics",
      "chunks": [2],
      "entity_type": "Organization"
  }
}


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  registry.local_to_global: Dict[str, str]                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                              â”‚
â”‚  Purpose: Map chunk-local IDs to global UIDs                            â”‚
â”‚  Key: "chunk_id:local_id" (e.g., "0:N1", "1:N2")                       â”‚
â”‚  Value: Global UID                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

local_to_global = {
    
  "0:N1": "abc123",        â† Chunk 0's N1 refers to Apple (uid: abc123)
  "0:N2": "def456",        â† Chunk 0's N2 refers to Steve Jobs
  
  "1:N1": "def456",        â† Chunk 1's N1 ALSO refers to Steve Jobs!
                              (same person, different chunk, different local ID)
  "1:N2": "xyz789",        â† Chunk 1's N2 refers to iPhone
  
  "2:N1": "abc123",        â† Chunk 2's N1 ALSO refers to Apple!
                              (same company as 0:N1, different chunk)
  "2:N2": "jkl012"         â† Chunk 2's N2 refers to Beats
}


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HOW THEY WORK TOGETHER                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Example: Processing relationship from Chunk 2
Relationship: {from: "N1", to: "N2", type: "ACQUIRED", _chunk_id: 2}

Step 1: Look up source entity
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  from_local = "N1"
  chunk_id = 2
  mapping_key = "2:N1"
  
  source_uid = local_to_global["2:N1"]  â†’ "abc123"
  
Step 2: Get entity details (optional, for verification)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  entity = entities["apple"]  â†’ {uid: "abc123", name: "Apple", ...}
  
Step 3: Look up target entity
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  to_local = "N2"
  mapping_key = "2:N2"
  
  target_uid = local_to_global["2:N2"]  â†’ "jkl012"
  
Step 4: Create relationship in Neo4j
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  MATCH (a:Entity {uid: "abc123"})     â† Finds the Apple node
  MATCH (b:Entity {uid: "jkl012"})     â† Finds the Beats node
  MERGE (a)-[r:RELATIONSHIP]->(b)       â† Creates relationship
  
  âœ“ Success! Even though this relationship is from Chunk 2,
    it correctly connects to the Apple node created from Chunk 0!
```

---

## ğŸ“Š DIAGRAM 4: Step-by-Step Registration Process

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              REGISTERING AN ENTITY: DETAILED WALKTHROUGH                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INPUT:
â”â”â”â”â”â”
node = {
    "id": "N1",
    "label": "Organization",
    "properties": {
        "name": "Apple Inc."
    }
}
chunk_id = 2

STEP 1: Extract and Normalize Name
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  raw_name = node["properties"]["name"]     â†’ "Apple Inc."
  normalized_name = normalize(raw_name)     â†’ "apple inc"
                                              (lowercase, trimmed)

STEP 2: Generate UID
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  uid = hash(normalized_name)               â†’ hash("apple inc") = "abc123"
                                              â†‘
                                      CRITICAL: Only uses name!
                                      Same name = same UID always!

STEP 3: Create Local-to-Global Mapping
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  local_id = node["id"]                     â†’ "N1"
  mapping_key = f"{chunk_id}:{local_id}"   â†’ "2:N1"
  
  registry.local_to_global["2:N1"] = "abc123"
                                      â†‘
                            Maps this chunk's local ID
                            to the global UID

STEP 4: Check if Entity Already Exists
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  if normalized_name in registry.entities:
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ENTITY EXISTS! (from previous chunk)    â”‚
      â”‚                                         â”‚
      â”‚ Update it:                              â”‚
      â”‚ - Add new chunk_id to chunks list       â”‚
      â”‚ - Merge any new properties              â”‚
      â”‚ - Keep same UID                         â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      
      Before: entities["apple inc"] = {
          uid: "abc123",
          chunks: [0],      â† Was only in chunk 0
          ...
      }
      
      After: entities["apple inc"] = {
          uid: "abc123",    â† SAME UID!
          chunks: [0, 2],   â† Now in chunks 0 AND 2
          ...
      }
      
  else:
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ NEW ENTITY! (first time seeing it)      â”‚
      â”‚                                         â”‚
      â”‚ Create new entry:                       â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      
      entities["apple inc"] = {
          "uid": "abc123",
          "name": "Apple Inc.",
          "normalized_name": "apple inc",
          "chunks": [2],
          "properties": {"name": "Apple Inc."},
          "entity_type": "Organization"
      }

FINAL STATE AFTER REGISTRATION:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  âœ“ Entity stored in entities dict (or updated if existed)
  âœ“ Mapping "2:N1" â†’ "abc123" stored in local_to_global
  âœ“ Ready to create node and relationships!
```

---

## ğŸ“Š DIAGRAM 5: Memory Visualization

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   MEMORY STATE DURING PROCESSING                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BEFORE PROCESSING:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
registry = GlobalEntityRegistry()

Memory:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ entities = {}        â”‚  â† Empty
â”‚ local_to_global = {} â”‚  â† Empty
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


AFTER PROCESSING CHUNK 0:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Chunk 0: "Apple was founded by Steve Jobs"

Memory:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ entities = {                                           â”‚
â”‚   "apple": {uid: "abc123", chunks: [0], ...},         â”‚
â”‚   "steve jobs": {uid: "def456", chunks: [0], ...}     â”‚
â”‚ }                                                      â”‚
â”‚                                                        â”‚
â”‚ local_to_global = {                                    â”‚
â”‚   "0:N1": "abc123",      # Chunk 0's N1 â†’ Apple       â”‚
â”‚   "0:N2": "def456"       # Chunk 0's N2 â†’ Steve Jobs  â”‚
â”‚ }                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


AFTER PROCESSING CHUNK 1:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Chunk 1: "Steve Jobs introduced the iPhone"

Memory:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ entities = {                                           â”‚
â”‚   "apple": {uid: "abc123", chunks: [0], ...},         â”‚
â”‚   "steve jobs": {                                      â”‚
â”‚       uid: "def456",                                   â”‚
â”‚       chunks: [0, 1],  â† UPDATED! Added chunk 1       â”‚
â”‚       ...                                              â”‚
â”‚   },                                                   â”‚
â”‚   "iphone": {uid: "xyz789", chunks: [1], ...}  â† NEW! â”‚
â”‚ }                                                      â”‚
â”‚                                                        â”‚
â”‚ local_to_global = {                                    â”‚
â”‚   "0:N1": "abc123",                                    â”‚
â”‚   "0:N2": "def456",                                    â”‚
â”‚   "1:N1": "def456",  â† NEW! Chunk 1's N1 â†’ S. Jobs   â”‚
â”‚   "1:N2": "xyz789"   â† NEW! Chunk 1's N2 â†’ iPhone    â”‚
â”‚ }                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


AFTER PROCESSING CHUNK 2:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Chunk 2: "Apple acquired Beats Electronics"

Memory:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ entities = {                                           â”‚
â”‚   "apple": {                                           â”‚
â”‚       uid: "abc123",                                   â”‚
â”‚       chunks: [0, 2],  â† UPDATED! Added chunk 2       â”‚
â”‚       ...                                              â”‚
â”‚   },                                                   â”‚
â”‚   "steve jobs": {uid: "def456", chunks: [0, 1], ...}, â”‚
â”‚   "iphone": {uid: "xyz789", chunks: [1], ...},        â”‚
â”‚   "beats electronics": {                               â”‚
â”‚       uid: "jkl012",                                   â”‚
â”‚       chunks: [2],  â† NEW!                            â”‚
â”‚       ...                                              â”‚
â”‚   }                                                    â”‚
â”‚ }                                                      â”‚
â”‚                                                        â”‚
â”‚ local_to_global = {                                    â”‚
â”‚   "0:N1": "abc123",                                    â”‚
â”‚   "0:N2": "def456",                                    â”‚
â”‚   "1:N1": "def456",                                    â”‚
â”‚   "1:N2": "xyz789",                                    â”‚
â”‚   "2:N1": "abc123",  â† NEW! Chunk 2's N1 â†’ Apple     â”‚
â”‚   "2:N2": "jkl012"   â† NEW! Chunk 2's N2 â†’ Beats     â”‚
â”‚ }                                                      â”‚
â”‚                                                        â”‚
â”‚ ğŸ“Š STATISTICS:                                         â”‚
â”‚   Total unique entities: 4                             â”‚
â”‚   Entities in multiple chunks: 2 (Apple, Steve Jobs)  â”‚
â”‚   Total ID mappings: 6                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Key Takeaways for Students

1. **entities dict** = The "master list" of all unique entities
   - Key = normalized name (lowercase)
   - Value = all info about that entity
   - Same name â†’ same entry (prevents duplicates)

2. **local_to_global dict** = The "translation table"
   - Key = "chunk:local_id" (e.g., "2:N1")
   - Value = global UID
   - Allows finding entities across chunks

3. **Two-phase processing** = Critical for correctness
   - Phase 1: Collect everything (build registry)
   - Phase 2: Create everything (use registry)
   - Can't create as you go because need complete picture

4. **UID consistency** = The magic formula
   - Same name â†’ same hash â†’ same UID â†’ same node
   - Different chunks don't matter
   - Entity identity preserved across document
